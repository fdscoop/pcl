# üéØ Supabase Payments Table - Webhook Schema

## **Complete Payments Table Schema**

Here's the exact structure of the `payments` table that the webhook will populate:

### **Core Fields** (Always Required)
```json
{
  "id": "uuid",                           // Primary key - auto-generated
  "status": "pending|completed|failed",   // Payment status
  "amount": "integer",                    // Amount in paise (e.g., 10000 = ‚Çπ100)
  "currency": "string",                   // ISO currency code (INR)
  "payment_gateway": "string",            // e.g., "razorpay"
  "created_at": "timestamp",              // When payment record created
  "updated_at": "timestamp"               // Last update time
}
```

### **Razorpay Mapping Fields** (Webhook Updates These)
```json
{
  "razorpay_order_id": "string",          // Razorpay order_id (set by create-order)
  "razorpay_payment_id": "string",        // Razorpay payment_id (set by webhook)
  "razorpay_signature": "string",         // HMAC signature (set by webhook)
  "receipt": "string",                    // Receipt identifier
  "payment_method": "string"              // e.g., "card", "upi", "netbanking"
}
```

### **Timeline Fields** (Webhook Updates)
```json
{
  "completed_at": "timestamp",            // When payment completed
  "webhook_received_at": "timestamp",     // When webhook received
  "webhook_received": "boolean"           // Webhook confirmation flag
}
```

### **Business Context Fields**
```json
{
  "club_id": "uuid",                      // Which club made payment
  "match_id": "uuid",                     // Which match is being booked
  "paid_by": "uuid",                      // Which user paid
  "notes": "jsonb"                        // Custom notes (includes payment_id)
}
```

### **Cost Breakdown** (Optional)
```json
{
  "amount_breakdown": "jsonb"             // {stadium: 10000, referee: 5000, ...}
}
```

### **Refund Fields** (For refunds only)
```json
{
  "refund_status": "string",              // "pending", "completed"
  "refund_reason": "string",              // Reason for refund
  "refund_initiated_by": "uuid",          // User who initiated
  "refunded_at": "timestamp",             // When refunded
  "refunded_amount": "integer"            // Amount refunded in paise
}
```

### **Webhook Data** (Complete payload)
```json
{
  "webhook_data": "jsonb"                 // Full Razorpay webhook JSON
}
```

---

## **üîÑ Webhook Flow - Data Population**

### **Step 1: Create-Order API (Frontend)**
```sql
INSERT INTO payments (
  id,                    -- UUID generated by us
  status,                -- "pending"
  amount,                -- 43800 paise
  currency,              -- "INR"
  payment_gateway,       -- "razorpay"
  club_id,               -- club UUID
  match_id,              -- match UUID (optional)
  paid_by,               -- user UUID
  notes,                 -- {payment_id: "541c397b...", ...}
  receipt,               -- "MATCH_1768145919164..."
  created_at,            -- NOW()
  updated_at             -- NOW()
)
```

### **Step 2: Razorpay Order Creation (Backend API)**
```sql
UPDATE payments
SET
  razorpay_order_id = "order_S2cjj4ehuR6blE",  -- Razorpay order ID
  updated_at = NOW()
WHERE id = "541c397b-8926-4351-b758-1e620ead2c38"
```

### **Step 3: User Completes Payment (Razorpay Checkout)**
- User fills details in Razorpay modal
- Payment completed: `pay_S2cjuDTDgRXxKR`

### **Step 4: Webhook Fires (Razorpay ‚Üí Our Edge Function)**
```bash
POST https://uvifkmkdoiohqrdbwgzt.supabase.co/functions/v1/razorpay-webhook
Headers:
  x-razorpay-signature: 9ef4dffbfd84f1318f6739a3ce19f9d9838c7c06...
  Content-Type: application/json

Body:
{
  "event": "payment.captured",
  "created_at": 1768145970,
  "payload": {
    "payment": {
      "entity": {
        "id": "pay_S2cjuDTDgRXxKR",
        "order_id": "order_S2cjj4ehuR6blE",
        "amount": 43800,
        "currency": "INR",
        "method": "card",
        "notes": {
          "payment_id": "541c397b-8926-4351-b758-1e620ead2c38",
          "club_id": "...",
          "stadium_id": "..."
        }
      }
    }
  }
}
```

### **Step 5: Webhook Updates Payment (Edge Function)**
```sql
UPDATE payments
SET
  razorpay_payment_id = "pay_S2cjuDTDgRXxKR",  -- From webhook
  razorpay_signature = "9ef4dffbfd84f1318f6739...",  -- Verified signature
  status = "completed",                          -- Mark as successful
  payment_method = "card",                       -- From webhook
  completed_at = NOW(),                          -- Completion time
  webhook_received = true,                       -- Confirmation
  webhook_received_at = NOW(),                   -- When received
  webhook_data = {...},                          -- Full webhook payload
  updated_at = NOW()
WHERE id = "541c397b-8926-4351-b758-1e620ead2c38"
```

### **Step 6: Frontend Polling Finds Updated Record**
```sql
SELECT * FROM payments
WHERE razorpay_payment_id = "pay_S2cjuDTDgRXxKR"
  AND status = "completed"
-- ‚úÖ Success! Record found with completed status
```

### **Step 7: Match Creation Proceeds**
```sql
INSERT INTO matches (
  payment_id = "541c397b-8926-4351-b758-1e620ead2c38",
  status = "confirmed",
  ...
)
-- ‚úÖ Match created with confirmed status
```

---

## **üìä Key State Transitions**

| Event | Status | razorpay_payment_id | webhook_received |
|-------|--------|---------------------|------------------|
| Payment record created | `pending` | `NULL` | `false` |
| Razorpay order created | `pending` | `NULL` | `false` |
| User pays in checkout | `pending` | `NULL` | `false` |
| Webhook fires & updates | `completed` | `pay_S2cj...` | `true` |
| Frontend polls & finds | `completed` | `pay_S2cj...` | `true` |
| Match creation starts | `confirmed` | `pay_S2cj...` | `true` |

---

## **üîê Security: HMAC Signature Verification**

The webhook signature is verified using:
```
Expected Signature = HMAC-SHA256(webhook_body, "pcl.fdscoop")
Actual Signature = x-razorpay-signature header

‚úÖ If signatures match: Webhook is from Razorpay, trusted
‚ùå If signatures don't match: Reject webhook with 400 error
```

---

## **‚úÖ Ready for Testing**

Your schema is complete and ready! When you make a payment in dev:

1. ‚úÖ Payment record created immediately (you'll see `razorpay_payment_id: NULL`)
2. ‚úÖ Complete payment in Razorpay checkout
3. ‚úÖ Webhook fires and updates record (should see `razorpay_payment_id: "pay_S2c..."`  and `status: "completed"`)
4. ‚úÖ Frontend polling finds the updated record
5. ‚úÖ Match creation proceeds automatically

Monitor the payment record changes in Supabase Dashboard ‚Üí Table Editor ‚Üí payments! üöÄ